@page "/relatorios/categorias"
@attribute [Authorize]
@using System.Net.Http.Json
@using System.ComponentModel.DataAnnotations
@using ControleDespesas.Models
@using Microsoft.AspNetCore.Components.Forms
@implements IAsyncDisposable
@inject IJSRuntime JS
@inject HttpClient Http
@inject MudBlazor.ISnackbar Snackbar
@inject NavigationManager NavigationManager


<h3>Relatório por Categoria</h3>

<div class="mb-3 d-flex gap-3 align-items-end">
    <div>
        <label class="form-label">Início</label>
        <InputDate class="form-control" @bind-Value="startDate" />
    </div>
    <div>
        <label class="form-label">Fim</label>
        <InputDate class="form-control" @bind-Value="endDate" />
    </div>
    <div>
        <label class="form-label">Categoria</label>
        <select class="form-select" @bind="selectedCategoriaId">
            <option value="0">Todas</option>
            @if (categorias != null)
            {
                @foreach (var c in categorias)
                {
                    <option value="@c.Id">@c.Nome</option>
                }
            }
        </select>
    </div>
    <div>
        <button class="btn btn-primary" @onclick="ApplyFilters">Aplicar</button>
        <button class="btn btn-secondary ms-2" @onclick="ClearFilters">Limpar</button>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5>Saldo por categoria</h5>
                @if (combinedTotals != null && combinedTotals.Any())
                {
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Categoria</th>
                                <th class="text-end">Saldo</th>
                                <th class="text-end">% do Saldo</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var t in combinedTotals)
                            {
                                <tr>
                                    <td>@t.Categoria</td>
                                    <td class="text-end">@t.Saldo.ToString("C")</td>
                                    <td class="text-end">@((Math.Abs(t.Saldo) / (totalSaldo == 0 ? 1 : totalSaldo) * 100).ToString("F2"))%</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <p>Sem transações para o período selecionado.</p>
                }
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <h6>Saldo por Categoria (Pizza)</h6>
        <canvas id="pieChartSaldo" class="mx-auto d-block" style="max-width:40%;height:250px"></canvas>
    </div>
</div>

@code {
    private DateTime? startDate;
    private DateTime? endDate;
    private int selectedCategoriaId = 0;

    private List<TransacaoDto>? transacoes;
    private List<Categoria>? categorias;

    private List<(string Categoria, double Total)> totaisReceitasPorCategoria = new();
    private List<(string Categoria, double Total)> totaisDespesasPorCategoria = new();
    private List<(string Categoria, double Receitas, double Despesas, double Saldo)> combinedTotals = new();
    private double totalSaldo = 0;
    private bool needChartRefresh = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadCategoriasAsync();
        // default to current month
        var now = DateTime.UtcNow;
        startDate = new DateTime(now.Year, now.Month, 1);
        endDate = startDate.Value.AddMonths(1).AddDays(-1);
        await LoadDataAsync();
    }

    private async Task LoadCategoriasAsync()
    {
        try
        {
            var response = await Http.GetAsync("api/Categoria");
            if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                NavigationManager.NavigateTo("/login");
                return;
            }
            if (!response.IsSuccessStatusCode)
            {
                Snackbar.Add($"Erro ao carregar categorias: {response.StatusCode}", MudBlazor.Severity.Error);
                return;
            }
            categorias = await response.Content.ReadFromJsonAsync<List<Categoria>>();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao carregar categorias: {ex.Message}", MudBlazor.Severity.Error);
        }
    }

    private async Task LoadDataAsync()
    {
        try
        {
            var query = new List<string>();
            if (startDate.HasValue) query.Add($"startDate={Uri.EscapeDataString(startDate.Value.ToString("yyyy-MM-dd"))}");
            if (endDate.HasValue) query.Add($"endDate={Uri.EscapeDataString(endDate.Value.ToString("yyyy-MM-dd"))}");
            if (selectedCategoriaId > 0) query.Add($"categoriaId={selectedCategoriaId}");

            var url = "api/Transacoes" + (query.Count > 0 ? "?" + string.Join("&", query) : string.Empty);
            var response = await Http.GetAsync(url);
            if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                NavigationManager.NavigateTo("/login");
                return;
            }
            if (!response.IsSuccessStatusCode)
            {
                Snackbar.Add($"Erro ao carregar transações: {response.StatusCode}", MudBlazor.Severity.Error);
                return;
            }
            transacoes = await response.Content.ReadFromJsonAsync<List<TransacaoDto>>();

            // split receitas / despesas
            var source = transacoes ?? new List<TransacaoDto>();

            var groupedReceitas = source
                .Where(t => string.Equals(t.Tipo, "Receita", StringComparison.OrdinalIgnoreCase))
                .GroupBy(t => t.CategoriaNome ?? "(Sem categoria)")
                .Select(g => new { Categoria = g.Key, Total = (double)g.Sum(x => x.Valor) })
                .OrderByDescending(x => x.Total)
                .ToList();

            var groupedDespesas = source
                .Where(t => string.Equals(t.Tipo, "Despesa", StringComparison.OrdinalIgnoreCase))
                .GroupBy(t => t.CategoriaNome ?? "(Sem categoria)")
                .Select(g => new { Categoria = g.Key, Total = (double)g.Sum(x => x.Valor) })
                .OrderByDescending(x => x.Total)
                .ToList();

            totaisReceitasPorCategoria = groupedReceitas.Select(g => (g.Categoria, g.Total)).ToList();
            totaisDespesasPorCategoria = groupedDespesas.Select(g => (g.Categoria, g.Total)).ToList();

            // totals
            // combined table rows (union of categories)

            // combined table rows (union of categories)
            var cats = new HashSet<string>(totaisReceitasPorCategoria.Select(x => x.Categoria));
            cats.UnionWith(totaisDespesasPorCategoria.Select(x => x.Categoria));

            combinedTotals = cats.Select(cat =>
            {
                var rec = totaisReceitasPorCategoria.FirstOrDefault(x => x.Categoria == cat).Total;
                var desp = totaisDespesasPorCategoria.FirstOrDefault(x => x.Categoria == cat).Total;
                return (Categoria: cat, Receitas: rec, Despesas: desp, Saldo: rec - desp);
            }).OrderByDescending(x => x.Saldo).ToList();

            // total absolute saldo for percent calculation
            totalSaldo = combinedTotals.Sum(x => Math.Abs(x.Saldo));

            // request chart render on next render pass
            needChartRefresh = true;
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao carregar transações: {ex.Message}", MudBlazor.Severity.Error);
        }
    }

    private async Task ApplyFilters()
    {
        await LoadDataAsync();
    }

    private async Task ClearFilters()
    {
        startDate = null;
        endDate = null;
        selectedCategoriaId = 0;
        await LoadDataAsync();
    }

    private class TransacaoDto { public int Id { get; set; } public decimal Valor { get; set; } public DateTime Data { get; set; } public string? Tipo { get; set; } public int CategoriaId { get; set; } public string? CategoriaNome { get; set; } public int UsuarioId { get; set; } public string? UsuarioEmail { get; set; } public string? Descricao { get; set; } }

    private async Task RenderChartAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("console.log", "RenderChartAsync called");
            var pieCanvasExists = await JS.InvokeAsync<bool>("chartInterop.canvasExists", "pieChartSaldo");
            await JS.InvokeVoidAsync("console.log", $"pieCanvasExists: {pieCanvasExists}");
            if (!pieCanvasExists) return;

            if (combinedTotals == null || !combinedTotals.Any())
            {
                await JS.InvokeVoidAsync("console.log", "No data for charts");
                if (pieCanvasExists) await JS.InvokeVoidAsync("chartInterop.destroyChart", "pieChartSaldo");
                return;
            }

            var labels = combinedTotals.Select(t => t.Categoria).ToArray();
            var values = combinedTotals.Select(t => Math.Abs(t.Saldo)).ToArray();
            await JS.InvokeVoidAsync("console.log", $"Labels: {string.Join(", ", labels)}, Values: {string.Join(", ", values)}");
            if (pieCanvasExists) await JS.InvokeVoidAsync("chartInterop.renderPieChart", "pieChartSaldo", labels, values);
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.log", $"Error in RenderChartAsync: {ex.Message}");
            try { Snackbar.Add($"Erro ao renderizar gráfico: {ex.Message}", MudBlazor.Severity.Warning); } catch { }
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (needChartRefresh)
        {
            needChartRefresh = false;
            await Task.Delay(100); // Delay to ensure DOM is fully updated
            try
            {
                await RenderChartAsync();
            }
            catch
            {
                // Ignore chart errors
            }
        }
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            var pieExists = await JS.InvokeAsync<bool>("chartInterop.canvasExists", "pieChartSaldo");
            if (pieExists) await JS.InvokeVoidAsync("chartInterop.destroyChart", "pieChartSaldo");
        }
        catch
        {
            // Ignore
        }
    }
}
